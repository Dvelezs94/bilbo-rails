$(document).on('turbolinks:load', function() {
  if ($("#bilbomap").length) {
    google.maps.event.addDomListener(window, 'turbolinks:load', initializeMap);
  }
});
function initializeMap() {

  var bilbos = JSON.parse($("#bilboMarkers").val())
  // center of mexico
  var center = new google.maps.LatLng( parseFloat($.getUrlVar("lat")) ||23.959124, parseFloat($.getUrlVar("lng")) ||-102.482976);

  window.bilbomap = new google.maps.Map(document.getElementById('bilbomap'), {
    zoom: 4,
    center: center,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });

  build_markers(bilbos);

}
function build_markers(bilbos) {
  // build markers from the available bilbos
  window.markers = bilbos.map(function(bilbo) {
    var marker = new google.maps.Marker({
      position: bilbo
      // id: bilbo.id
    });

    if ($("#bilbomap").length > 0){
      google.maps.event.addListener(marker, 'click', function() {
        $("#boardInfo").addClass("d-none");
        $("#map-layout").removeClass("col-xl-12");
        $("#map-layout").addClass("col-xl-9");
        $("#loading").addClass("placeholder-paragraph");
        // alert('marker ' + marker.getPosition().lat() + ' clicked');
        $.ajax({
           url:  "/boards/get_info",
           dataType: "script",
           data: {lat: marker.getPosition().lat(), lng: marker.getPosition().lng(), selected_boards: $("#campaign_boards").val()},
           success: function(data) {
             $("#loading").removeClass("placeholder-paragraph");
             $("#boardInfo").removeClass("d-none");
            },
           error: function(data) {
             alert("parece que no est√°s conectado a internet.");
           }
        });
      });
    }

    return marker;
  });

  var options = {
    imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"
  };

  window.markerCluster = new MarkerClusterer(window.bilbomap, window.markers, options);
}
