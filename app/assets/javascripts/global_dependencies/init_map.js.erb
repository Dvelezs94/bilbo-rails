$(document).on('turbolinks:load', function() {
  if ($("#bilbomap").length > 0){
    var infowindow = null;
    google.maps.event.addDomListener(window, 'turbolinks:load', initializeMap);
  }
});
function initializeMap() {
  waitForElement("#bilbomap", function() {
    var bilbos = JSON.parse($("#bilboMarkers").val())

    // center of mexico
    var center = new google.maps.LatLng( parseFloat($("#mapLat").val()) || parseFloat($.getUrlVar("lat")) || 23.959124, parseFloat($("#mapLng").val()) || parseFloat($.getUrlVar("lng")) || -102.482976);
    var zoom = parseInt($("#mapZoom").val()) || parseInt($.getUrlVar("zoom")) || 6

    window.bilbomap = new google.maps.Map(document.getElementById('bilbomap'), {
      zoom: zoom,
      center: center,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      styles: [{"featureType":"all","elementType":"labels.text.fill","stylers":[{"color":"#7c93a3"},{"lightness":"-10"}]},{"featureType":"administrative.country","elementType":"geometry","stylers":[{"visibility":"on"}]},{"featureType":"administrative.country","elementType":"geometry.stroke","stylers":[{"color":"#a0a4a5"}]},{"featureType":"administrative.province","elementType":"geometry.stroke","stylers":[{"color":"#62838e"}]},{"featureType":"landscape","elementType":"geometry.fill","stylers":[{"color":"#dde3e3"}]},{"featureType":"landscape.man_made","elementType":"geometry.stroke","stylers":[{"color":"#3f4a51"},{"weight":"0.30"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"poi.attraction","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"poi.business","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.government","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.park","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"poi.place_of_worship","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.school","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.sports_complex","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":"-100"},{"visibility":"on"}]},{"featureType":"road","elementType":"geometry.stroke","stylers":[{"visibility":"on"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#bbcacf"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"lightness":"0"},{"color":"#bbcacf"},{"weight":"0.50"}]},{"featureType":"road.highway","elementType":"labels","stylers":[{"visibility":"on"}]},{"featureType":"road.highway","elementType":"labels.text","stylers":[{"visibility":"on"}]},{"featureType":"road.highway.controlled_access","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.highway.controlled_access","elementType":"geometry.stroke","stylers":[{"color":"#a9b4b8"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"invert_lightness":true},{"saturation":"-7"},{"lightness":"3"},{"gamma":"1.80"},{"weight":"0.01"}]},{"featureType":"transit.line","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#a3c7df"}]},{ "featureType": "road.arterial", "elementType": "labels", "stylers": [ { "visibility": "off" } ] }],
      disableDefaultUI: true,
      zoomControl: true,
    });

    infowindow = new google.maps.InfoWindow();

    build_markers(bilbos);
    // build_circles(bilbos);
  });
}

// function build_circles(bilbos) {
//   for (const pinpoint in bilbos) {
//     if (bilbos[pinpoint]["category"] == "pinmarker") {
//       // Add the cicrircle for this city to the map.
//       const branchCircle = new google.maps.Circle({
//       strokeColor: "#7CA0C0",
//       strokeOpacity: 0.8,
//       strokeWeight: 2,
//       fillColor: "#7CA0C0",
//       fillOpacity: 0.35,
//       map: window.bilbomap,
//       center: { lat: bilbos[pinpoint]["lat"], lng: bilbos[pinpoint]["lng"] },
//       radius: 2000,
//     });
//     }
//   }
// }

function build_markers(bilbos) {
  // build markers from the available bilbos
  window.markers = bilbos.filter(function(bilbo) {
      if ( bilbo["category"] == "pinmarker" ) {
        return false; // skip pin markers because we want them to be circles
      }
      return true;
    }).map(function(bilbo) {
      var marker = new google.maps.Marker({
      position: { lat: bilbo["lat"], lng: bilbo["lng"] },
      map: window.bilbomap,
      icon: "https://content-bilbo.app.bilbo.mx/statics/maps/markers/" + bilbo["category"] + "_svg.svg"
    });

    if ($("#bilbomap").length && $("#boardInfo").length){
      google.maps.event.addListener(marker, 'click', function() {
        $("#boardInfo").addClass("d-none");
        $("#map-layout").removeClass("col-xl-12");
        $("#map-layout").addClass("col-xl-9");
        $("#loading").addClass("placeholder-paragraph");
        // alert('marker ' + marker.getPosition().lat() + ' clicked');
        $.ajax({
           url:  "/boards/get_info",
           dataType: "script",
           data: {lat: marker.getPosition().lat(), lng: marker.getPosition().lng(), selected_boards: $("#campaign_boards").val()},
           success: function(data) {
              if (infowindow) {
                 infowindow.close();
               }
              infowindow.setContent(`<div> ${$("#board_info_face").text()} </div>`)
              infowindow.open(window.bilbomap, marker);

             $("#loading").removeClass("placeholder-paragraph");
             $("#boardInfo").removeClass("d-none");
            },
           error: function(data) {
             alert("parece que no est√°s conectado a internet.");
           }
        });
      });
    }

    return marker;
  });

  // var options = {
  //   imagePath: "https://cdn-bilbo.app.bilbo.mx/statics/maps/markercluster/m"
  // };
  //
  // window.markerCluster = new MarkerClusterer(window.bilbomap, window.markers, options);
}
